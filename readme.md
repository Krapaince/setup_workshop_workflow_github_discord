# Workshop - Organize your workflow with Github and Discord

This file is step by step guide to setup a project like in the following image:
![](resource/project.jpg)

To follow this tutorial you need the blih script of epitech. It can be found [here](https://gitlab.com/EpitechContent/dump/-/tree/master)

You migth create a test repository on github and on epitech to test that everything is working as expected. In this tutorial we will call our github test repository `git_repo` and our epitech one `epi_repo`.

## Setup the push chain
![](resource/push_chain.jpg)

### Step 1: Setup ssh keys between you and Github

In order to push on Github, you need to setup an sshkey. As you generate one during your CPool, you must generate a key for `github.com`

- Generate a new key
```bash
cd ~/.ssh # Go to the folder in which you store your ssh keys
ssh-keygen -f id_rsa_github -C "your_email@example.com"
```

A pair keys are generated by this command. The public key `id_rsa_github.pub` and the private key `id_rsa_github`.

After generating your key, you must add, the public part of the key to your github account.

`Note`: if github tell you that the key is incorrect, generate the key with this command
```bash
ssh-keygen -f id_rsa_github -C "your_email@example.com" -t rsa -b 4096
```

`Note`: You can use the same key as you use for epitech already. But for security purpose, you should generate a new one.

- Upload your key on github

Go to the website github.com and connect yourself with your github account.
Once connected, your can go the setting of your account (https://github.com/settings/profile).

Go to the section `SSH and GPG keys` and add a `New SSH key`.
Give the key a good title so that you can remember from where your key come from. Then paste in the key input the content of the public key (`~/.ssh/id_rsa_github.pub`).
![](resource/github_ssh_key.png)

- Create ssh config

Once your ssh key is uploaded on github, you should be able to clone your github repository in theory. But if you think by yourself, there is now two pairs of ssh keys in `~/.ssh` so which one should ssh choose.

Awnser: if there isn't a config file it chooses the first key that it finds.

To solve this problem you must create a configuration file in your `~/.ssh` folder like so:
```bash
cd ~/.ssh
touch config
```
Add this to the `config` file:
```
Host git.epitech.eu
	HostName git.epitech.eu
	User git
	IdentityFile ~/.ssh/id_rsa_epitech

Host github.com
	HostName github.com
	User git
	IdentityFile ~/.ssh/id_rsa_github
```
Your ssh configuration now specifies which key should be use for each host.

`Note`: __Pay attention to the path after `IdentifyFile`, it must match your key filename__.

SSH identification process needs a particular file mode on `~/.ssh/config` to use it. The file must be `read-only`. Here is the command to apply this mode
```bash
chmod 400 ~/.ssh/config
```

#### Checkpoint Setup Github ssh keys
You are now able to work with the git of `github.com` and the git of `git.epitech.eu`.
Try to `clone` / `push` on the two hosts to be sure that your ssh configuration is working as expected.

### Step 2: Setup Github ssh keys between Github and Epitech (deploy key)

Now that you can push on your github repository, we need to give at our github repository an access to our epitech one.

- Generate the `deploy_key`:


We will need an another SSH key to perform this operation. This key will only be used for automatic operation so you can put it in a subfolder of `~/.ssh`:
```bash
cd ~/.ssh
mkdir deploy_key
cd deploy_key
ssh-keygen -f id_rsa_github_to_epitech -C "deploy_key_github_to_epitech"
```
`Note`: Naming those keys is not important for now. But when you will come back in a month you may not remember which one is use for what. So put those names on your key files!

- Setup the public deploy key (Epitech):

Now that you have generated your deploy key, upload the public part on epitech with `blih`
```bash
blih -u firstname.lastname@epitech.eu sshkey upload ~/.ssh/deploy_key/id_rsa_github_to_epitech.pub
```

- Setup the private deploy key (Github):

The private part will be put in the secret of our repository. Go to your repository page then click on the setting tab. Then go to the secrets section.

In this private section click on `Add secret`. Name your secret with a good name this will be used later to access at our private key (`SSH_PRIVATE_KEY_EPITECH`).

Paste the content of your private key in the value field.
```bash
cat ~/.ssh/deploy_key/id_rsa_github_to_epitech
```

`Note`: If you want to use another name, it must be in UPPER_CAMEL_CASE.
![](resource/github_deploy_key_private.png)

- Setup the `workflow`

We now need to setup a workflow. But first what is a workflow ?

A `workflow` is a set of `jobs`. A `job` is compose with a set of `steps`. A `step` is a simple command (e.g: `make tests_run`).

When a `workflow` will be launch it will run each `job` in parallel. The `steps` composing a job will then be run one by one.

Now that you know a bit more about the `workflow` of github, let's setup it.

To run a workflow you need first to create one. Copy the `workflow.yml` at the root of this repository and put it in your `git_repo` like so:
```bash
./git_repo/
└── .github/
    └── workflows/
        └── workflow.yml
```

Now that you put this file in your repository, let's see how it work. We also need to configure some ligns inside.

We will start with what trigger the workflow.

```yml
# at each push or pull_request on the branch master run the jobs
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# [...]
```
Now let's see how to setup the `jobs`
```yml
# [...]

jobs: # Start the jobs section
  build: # Declare a new job with as id 'build'
    name: Build Checker # Give a name to the job
    runs-on: ubuntu-latest # Define on what should the job run you can find more information here:
                           # https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on
    steps: # Start the step section
      # A Step start with '-'. All the following pair of 'key: value' will be part of the step until the next '-'
      # For futher information about the yml can be find here: https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#about-yaml-syntax-for-workflows

      - uses: actions/checkout@v2 # 'uses' specify the usage of an action (individual tasks)
                                  # Futher informations about action: https://help.github.com/en/actions
        # 'checkout' action will clone the repository with only the last commit of master

      - name: Build Standard # Define a step name 'Build Standard' which will run the command 'make' in a shell of type `bash`
        shell: bash
        run: make

  tests: # Another job ...
    name: Test Runner
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: BuildTest
        shell: bash
        run: make tests_run

# [...]
```

Now that we have jobs to run our unit tests and to build our project, let's see how to push to our `epi_repo` in case of success

```yml
# [...]

jobs:

# [...]

  deploy: # Just another job name 'deploy', otherwise nothing to read here
    name: Deploy
    needs: [build, tests] # 'needs' allow us to make the job wait for other jobs to complete. Here we wait for the jobs 'build' and 'tests'.
                          #  If one of the build fail in the set of needs, this task won't be executed.
    runs-on: [ubuntu-latest]
    steps:
      - name: Set up ssh key # To push on our epitech repository we will need a private key. This private key is the deploy key that we have put in the secret section of our github repository.
        uses: webfactory/ssh-agent@v0.2.0 # 'ssh-agent' will get the key from the repository secret and setup it.
        with: # If you have name your deploy key with a different name, you need to change 'SSH_PRIVATE_KEY_EPITECH' with your secret's name.
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY_EPITECH }}

      - name: Clone Repository # We use the same action has we use in our 'build' and 'tests' jobs to clone our repository. But we use it with some arguments to clone the entire history of the master branch.
        uses: actions/checkout@v2
        with:
          ref: 'master'
          fetch-depth: '0' # get all history of master

      #Push on an epitech repository
      - name: Add host git.epitech.eu # By default ssh will ask you if you use a new host if it his a trusted one. Here we add it before any operation with ssh so that it won't ask us a confirmation.
        shell: bash
        run: ssh-keyscan git.epitech.eu >> ~/.ssh/known_hosts

      - name: Set up remote (epitech) # To push our repository to another remote we need to setup a new one.
        shell: bash # Of course you need to edit the remote url to match with your epitech repository
        run: |
          git remote add epitech git@git.epitech.eu:firstname.lastname@epitech.eu/epi_repo


      - name : Push to repository (epitech)
        shell: bash # Finally we push our master branch to the `epi_repo` by specifing our epitech remote.
        run: |
          git push epitech master
```

Now that you know everything about this workflow, you can push it to your `git_repo`.

#### Checkpoint Worflow github
Now that your two repositories are setup, you should test to push the content of the `project.zip` in your `git_repo`.
To check if everything is working as expected you should go in the action section of your `git_repo` on github.
Check that the last workflow run with the commit on the `project.zip` push have succeded.
![](resource/github_workflow.png)

## Setup a webhook
![](resource/webhook.jpg)

If you want to have a message when someone `push`, create a `pull request`, etc.., you can setup a `webhook`.
It can be easily setup take a look at this [tutorial](https://gist.github.com/eslachance/40ac1c8232a5a019b43ee3f588d637ad) or [this one](https://gist.github.com/jagrosh/5b1761213e33fc5b54ec7f6379034a22).

### Checkpoint Webhook

Test to trigger an event that you setup in your webhook. A message should pop in the discord channel.

## The end

Now that you have setup all your project you may add your teammates.

To work with them you may use `pull request`, `issue`, `project`, `wiki`. Those tools will allow you to track, report and follow the project more easily than a separated tool like `trello`.

If you want more information to use github:

- https://guides.github.com/features/issues/

- https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/proposing-changes-to-your-work-with-pull-requests

- https://help.github.com/en/github/managing-your-work-on-github/managing-your-work-with-issues